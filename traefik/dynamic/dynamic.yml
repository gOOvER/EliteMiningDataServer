# Dynamic configuration for Traefik
# This file contains middleware and other dynamic configurations

# HTTP middleware
http:
  # Security headers middleware
  middlewares:
    security-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          X-Frame-Options: "DENY"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
          Strict-Transport-Security: "max-age=31536000; includeSubDomains"
          Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"

    # Rate limiting middleware
    rate-limit:
      rateLimit:
        average: 100
        burst: 200
        period: "1m"

    # CORS middleware for API
    cors-headers:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowOriginList:
          - "*"  # Configure specific origins in production
        accessControlMaxAge: 100
        addVaryHeader: true

    # Basic auth for admin interfaces (development only)
    admin-auth:
      basicAuth:
        users:
          - "admin:$2y$10$..."  # Use htpasswd to generate this

    # CrowdSec bouncer middleware
    crowdsec-bouncer:
      forwardAuth:
        address: "http://crowdsec-bouncer:8080/api/v1/forwardAuth"
        authResponseHeaders:
          - "X-Crowdsec-Decision"

  # Services configuration
  services:
    # Traefik dashboard service
    traefik-dashboard:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:8080"

  # Routers configuration
  routers:
    # Dashboard router (secure in production)
    traefik-dashboard:
      rule: "Host(`traefik.yourdomain.com`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      service: "traefik-dashboard"
      entryPoints:
        - "websecure"
      middlewares:
        - "admin-auth"  # Uncomment for production
        - "security-headers"
      tls:
        certResolver: "letsencrypt"

# TCP configuration (if needed for database connections)
tcp:
  routers: {}
  services: {}

# UDP configuration (if needed)
udp:
  routers: {}
  services: {}