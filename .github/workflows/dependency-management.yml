name: Dependency Management

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    paths:
      - 'package.json'
      - 'package-lock.json'

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: Install npm-check-updates
      run: npm install -g npm-check-updates

    - name: Check for updates
      id: updates
      run: |
        ncu --output json > updates.json
        if [ -s updates.json ] && [ "$(cat updates.json)" != "{}" ]; then
          echo "updates_available=true" >> $GITHUB_OUTPUT
          echo "Updates available:"
          cat updates.json
        else
          echo "updates_available=false" >> $GITHUB_OUTPUT
          echo "No updates available"
        fi

    - name: Update dependencies
      if: steps.updates.outputs.updates_available == 'true'
      run: |
        # Update patch and minor versions
        ncu -u --target patch
        ncu -u --target minor --filter "/^(?!(@types\/|eslint|jest|supertest)).*/"
        
        # Install updated dependencies
        npm install

    - name: Run tests after updates
      if: steps.updates.outputs.updates_available == 'true'
      run: |
        npm test
        npm run lint

    - name: Create Pull Request
      if: steps.updates.outputs.updates_available == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update dependencies'
        title: 'üîÑ Automated dependency updates'
        body: |
          ## Automated Dependency Updates
          
          This PR contains automated dependency updates:
          
          ### Updated packages:
          ```json
          $(cat updates.json)
          ```
          
          ### Verification:
          - ‚úÖ Tests passing
          - ‚úÖ Linting passed
          - ‚úÖ Security audit clean
          
          **Note**: This PR was created automatically. Please review the changes before merging.
          
          ---
          *Generated by GitHub Actions*
        branch: automated/dependency-updates
        delete-branch: true
        labels: |
          dependencies
          automated
          patch

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      run: |
        npm audit --audit-level=low --json > audit-results.json || true
        
    - name: Process audit results
      run: |
        if [ -s audit-results.json ]; then
          CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
          MODERATE=$(cat audit-results.json | jq '.metadata.vulnerabilities.moderate // 0')
          
          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"
          echo "Moderate vulnerabilities: $MODERATE"
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "‚ùå Critical or high vulnerabilities found!"
            npm audit
            exit 1
          elif [ "$MODERATE" -gt 0 ]; then
            echo "‚ö†Ô∏è Moderate vulnerabilities found"
            npm audit
          else
            echo "‚úÖ No significant vulnerabilities found"
          fi
        fi

    - name: Upload audit results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-results
        path: audit-results.json

  docker-updates:
    name: Docker Base Image Updates
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for Docker base image updates
      id: docker-check
      run: |
        # Check current Node.js version in Dockerfile
        CURRENT_NODE=$(grep "FROM node:" Dockerfile | head -1 | cut -d':' -f2 | cut -d'-' -f1)
        echo "Current Node version: $CURRENT_NODE"
        
        # Get latest LTS version
        LATEST_LTS=$(curl -s https://nodejs.org/dist/index.json | jq -r '[.[] | select(.lts != false)] | .[0].version' | cut -d'v' -f2)
        echo "Latest LTS version: $LATEST_LTS"
        
        if [ "$CURRENT_NODE" != "$LATEST_LTS" ]; then
          echo "update_needed=true" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_NODE" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST_LTS" >> $GITHUB_OUTPUT
        else
          echo "update_needed=false" >> $GITHUB_OUTPUT
        fi

    - name: Update Dockerfile
      if: steps.docker-check.outputs.update_needed == 'true'
      run: |
        sed -i "s/FROM node:${{ steps.docker-check.outputs.current_version }}/FROM node:${{ steps.docker-check.outputs.latest_version }}/g" Dockerfile
        
    - name: Test updated Docker image
      if: steps.docker-check.outputs.update_needed == 'true'
      run: |
        docker build -t elite-mining-server:test-update .
        docker run --rm -d --name test-update -p 3001:3000 elite-mining-server:test-update
        sleep 10
        curl -f http://localhost:3001/health || exit 1
        docker stop test-update

    - name: Create Pull Request for Docker update
      if: steps.docker-check.outputs.update_needed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update Node.js base image to ${{ steps.docker-check.outputs.latest_version }}'
        title: 'üê≥ Update Node.js base image'
        body: |
          ## Docker Base Image Update
          
          Updates Node.js base image from `${{ steps.docker-check.outputs.current_version }}` to `${{ steps.docker-check.outputs.latest_version }}`.
          
          ### Changes:
          - Updated Dockerfile with latest Node.js LTS version
          - Tested Docker image build and health check
          
          ### Verification:
          - ‚úÖ Docker image builds successfully
          - ‚úÖ Health check passes
          
          ---
          *Generated by GitHub Actions*
        branch: automated/docker-updates
        delete-branch: true
        labels: |
          docker
          automated
          infrastructure